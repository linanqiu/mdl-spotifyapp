var request = require('request');
var async = require('async');

var ARTIST_URL = 'http://ws.spotify.com/search/1/artist.json?q=';
var ALBUM_URL = 'http://ws.spotify.com/lookup/1/.json?uri=ARTIST_URI&extras=albumdetail';

var SpotifyMetadataWorker = function(limit) {
  if (limit) {
    this.limit = limit;
  } else {
    this.limit = 5;
  }
}

// gets artists matching query, truncates to 5 (or fewer if queries return fewer) artists
SpotifyMetadataWorker.prototype.getLatestAlbum = function(artist, callback) {
  var limit = this.limit;

  request.get(ARTIST_URL + artist, function(err, resp, body) {
    if (err) {
      console.log(err);
    } else {
      var results = JSON.parse(body);
      artists = results['artists'];

      var searchArtists = [];

      for (var i = 0; i < Math.min(limit, results['info']['num_results']); i++) {
        searchArtists.push(artists[i]);
      }

      getRecentAlbums(searchArtists, callback);
    }
  });
}

// gets most recent album for each artist
function getRecentAlbums(artists, callback) {
  async.map(artists, function(artist, asynccallback) {
    request.get(ALBUM_URL.replace('ARTIST_URI', artist['href']), function(err, resp, body) {
      if (err) {
        console.log(err);
        asynccallback(true, null);
      } else {
        var results = JSON.parse(body);
        albums = results['artist']['albums'];

        var latestYear = 0;
        var latestAlbum = {};

        for (var i = 0; i < albums.length; i++) {
          var year = albums[i]['album']['released'];
          if (year > latestYear) {
            latestYear = year;
            latestAlbum = albums[i];
          }
        }

        asynccallback(false, latestAlbum);
      }
    });
  }, function(err, results) {
    if (err) {
      callback(true, null);
    } else {
      callback(false, results);
    }
  });
}

module.exports = SpotifyMetadataWorker;